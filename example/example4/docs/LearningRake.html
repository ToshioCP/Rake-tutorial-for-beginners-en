<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Toshio CP" />
  <meta name="dcterms.date" content="2022-08-03" />
  <title>Rake tutorial for beginners</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header id="title-block-header">
<h1 class="title">Rake tutorial for beginners</h1>
<p class="author">Toshio CP</p>
<p class="date">August 3, 2022</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#tasks">Tasks</a></li>
<li><a href="#file-task">File task</a></li>
<li><a href="#a-useful-example-of-rakefile-1-clean-and-clobber">A useful example of Rakefile (1), Clean and Clobber</a></li>
</ul>
</nav>
<h3 id="tasks">Tasks</h3>
<p>This tutorial is aimed at people learning Rake for the first time, but it is also useful for those already familiar with Rake. This tutorial features</p>
<ul>
<li>Explains how Rake works and how it works</li>
<li>Covers practical examples using Rake</li>
</ul>
<p>Through this tutorial, let’s acquire the ability to use Rake for various development.</p>
<p>The paragraph that starts with the symbol [R] in the text is “Commentary for advanced Ruby users”. <em>Advanced</em> basically refers to “a level where you can write a class”. Other users should skip this part.</p>
<h4 id="installing-rake">Installing Rake</h4>
<p>Rake is a Ruby application. For Ruby installation, refer to <a href="https://www.ruby-lang.org/en/documentation/installation/#package-management-systems">Ruby’s official website</a>. Rake is a Ruby’s standard library, so it is usually included in the installed Ruby. But if not,</p>
<ul>
<li>If you installed the ruby ​​package of the Linux distribution =&gt; install its rake package.</li>
<li>If you installed by another method =&gt; Install with <code>gem install rake</code> from the command line.</li>
</ul>
<h4 id="download-examples-of-this-document">Download examples of this document</h4>
<p>The Github repository of this documenti is <a href="https://github.com/ToshioCP/Rake-tutorial-for-beginners-en">here</a>. Click “Code” button (green button) and choose “Download ZIP”. You can also clone the repository with git.</p>
<h4 id="what-is-rake">What is Rake?</h4>
<p>Rake is a ruby application that implements the same functions as Make.</p>
<p>Make is a program developed to control the entire compilation process when compiling in C. But Make can control not only C, but also various compilers and translators (programs that convert from one format to another). Make is convenient, but its syntax is complicated. It’s easy to understand when you’re using it for the first time, but the more you use it, the more difficult it becomes to understand. For example:</p>
<pre><code>application: $(OBJS)
$(CC) -o $(@F) $(OBJS) $(LIBS)

$(OBJS): %.o: %.c $(HEADER)
$(CC) -fPIC -c -o $(@F) $(CFLAGS) $&lt;</code></pre>
<p>On the other hand, Rake is:</p>
<ul>
<li>Easy to understand because you can use Ruby language.</li>
<li>Therefore, you can write your code clearly and flexibly.</li>
</ul>
<p>Reference:</p>
<ul>
<li><a href="https://ruby.github.io/rake/index.html">RAKE - Ruby Make</a></li>
<li><a href="https://github.com/ruby/rake">Github, ruby/rake</a></li>
</ul>
<h4 id="rake-basics">Rake Basics</h4>
<p>First, the important point is the command <code>rake</code> and the file <code>Rakefile</code> placed in the current directory. The rake command takes a task name (tasks are explained later) as an argument.</p>
<pre><code>$ rake hello</code></pre>
<p>In this example the argument <code>hello</code> is the task name.</p>
<p><code>rake</code> will then do the following in order:</p>
<ul>
<li>Initialize Rake</li>
<li>Load and run Rakefile (Rakefile contains task definitions)</li>
<li>Invoke a task given from the command line argument</li>
</ul>
<p>When you use Rake, your main work is writing task definitions in your Rakefile. The task called from the command line must be defined in the Rakefile.</p>
<blockquote>
<p>[R] “Define/Declare a task” are used in the <a href="https://ruby.github.io/rake/doc/rakefile_rdoc.html">Rake documentation</a>. It actually means “create an instance of the Task class” in terms of Ruby syntax.</p>
</blockquote>
<h4 id="task-definition-in-rakefile">Task definition in Rakefile</h4>
<p>A task is an object that has a name, prerequisites, and an action. Prerequisites and an action are optional.</p>
<p>The first example below has only a name.</p>
<pre><code>task :simple_task</code></pre>
<p>Write the line above with your editor and save it as a file named <code>Rakefile</code>. The first element <code>task</code> can be considered to be a <em>command</em> which defines (or declares) a task.</p>
<p>In general, a <em>command</em> in a programming language is something that tells the computer to do something. For example, in Bash, <code>cd</code>" is the <em>command</em> to change the current directory. When you type <code>cd /var</code> in your command line, it moves the current directory to <code>/var</code>. It is the result of executing the <code>cd</code> command with the <code>/var</code> argument.</p>
<p>Similarly, the <code>task</code> command is given with the argument <code>:simple_task</code>. And executing the task command creates a task with the name simple_task. The argument <code>:simple_task</code> is a symbol, but you can also use a string like this:</p>
<pre><code>task &quot;simple_task&quot;</code></pre>
<p>The both created tasks are exactly the same.</p>
<p>On the other hand, the task command is actually a Ruby method from Ruby’s syntactic point of view, and <code>:simple_task</code> is an argument to the method. From now on, a task may be called a <em>command</em> or <em>methods</em> from the context.</p>
<ul>
<li>If it is focused on its “task creation” function, it will be called a <em>command</em>.</li>
<li>If it is thought as a method in Ruby’s syntax, it will be called a <em>method</em>.</li>
</ul>
<p>I think it won’t make any confusion and don’t worry too much about it.</p>
<blockquote>
<p>[R] From Ruby’s grammar, the <code>task</code> command is a “method call”, and <code>:simple_task</code> is an argument of the method. In Ruby, you can write arguments with or without parentheses so the example above is a correct ruby program. If you use parentheses,</p>
<pre><code>task(&quot;simple_task&quot;)</code></pre>
<p>Be careful that there’s no blank between the method and the left parenthesis.</p>
<p>You can define it either way, but it’s better to use it without parentheses.</p>
<p>“Defining a task” means “creating an instance of the Task class”. When you create a new instance, the class’s <code>new</code> method is usually called. But it is <em>not</em> the only way to create an instance. The <code>task</code> method calls <code>Task.new</code> in its body to create an instance. In addition, the <code>task</code> method is more convenient than <code>new</code> method.</p>
</blockquote>
<p>Task <code>simple_task</code> has no prerequisites and actions.</p>
<p>Let’s run the task from the command line. If you haven’t download the <a href="https://github.com/ToshioCP/Rake-tutorial-for-beginners-en">repository</a>, do it before executing rake.</p>
<p>It is assumed that the current directory is the top directory of the downloaded and unzipped data. Change your current directory to <code>example/example1</code>.</p>
<pre><code>$ ls
Rakefile  Rakefile2  Rakefile3  Rakefile4
$ cat Rakefile
task :simple_task
$ rake simple_task</code></pre>
<p>First, make sure that there exists <code>Rakefile</code>. Then, run rake. The task <code>simple_task</code> has been called, but since it has no action, nothing happened. Check whether the task is defined.</p>
<pre><code>$ rake -AT
rake simple_task#</code></pre>
<p>Option AT displays all registered tasks. Now you know that simple_task is defined.</p>
<h4 id="actions">actions</h4>
<p>Actions are represented by a block of the task method.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="st">task: </span>hello <span class="kw">do</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>  print <span class="st">&quot;Hello world!\n&quot;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>This task is named <code>hello</code>. hello has no prerequisites. The action is to display “Hello world!” on the screen.</p>
<p>The task command above is written in <code>Rakefile2</code>, not <code>Rakefile</code>. So, it is necessary to give rake the filename <code>Rakefile2</code> as a rakefile. To do this, <code>-f</code> option is used.</p>
<pre><code>$ cat Rakefile2
task: hello do
  print &quot;Hello world!\n&quot;
end
$ rake -f Rakefile2 hello
Hello world!</code></pre>
<p>The task hello was invoked and its action was executed. As a result, the string “Hello world!” was displayed.</p>
<blockquote>
<p>[R] Ruby has two ways of representing blocks: (1) curly braces (<code>{</code> and <code>}</code>) and (2) <code>do</code> and <code>end</code>. Both will work in a Rakefile, but it’s better to use <code>do</code> and <code>end</code> for readability. Also, if you use curly braces and write like this, it won’t work:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a>task <span class="st">:hello</span> {print <span class="st">&quot;Hello world!\n&quot;</span>}</span></code></pre></div>
<p>This causes an error because curly braces bind more tightly to the preceding expression than do-ends. Please see <a href="https://www.ruby-lang.org/en/documentation/faq/5/">Ruby FAQ</a> for further information. To fix this, put parentheses around the argument.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a>task(<span class="st">:hello</span>) {print <span class="st">&quot;Hello world!\n&quot;</span>}</span></code></pre></div>
<p>In Rakefile, it is good to express a task as if it were a command. Therefore, writing a task command with parenthses is NOT recommended.</p>
<p>Thanks to Ruby’s flexible syntax such as omitting parentheses in arguments, Ruby can make methods look like commands. And you can make a new language for a specific purpose. Such language is called “DSL (Domain-Specific Language)”. The idea that Rake is a kind of DSL, brings the do-end recommendation.</p>
</blockquote>
<h4 id="prerequisites">Prerequisites</h4>
<p>If a task has prerequistes, it call them before its action is invoked.</p>
<p>A task definition with prerequisites is like this:</p>
<pre><code>task task name =&gt; [ a list of prerequisites ] do
  action
end</code></pre>
<p><code>task name =&gt; [ a list of prerequisites ]</code> is a Ruby hash. You can leave out the braces (<code>{</code> and <code>}</code>) when the hash is the last argument of the method call. If you do not omit it, it will be <code>{ task name =&gt; [ a list of prerequisites ] }</code>. It also works.</p>
<p>If the task name is a symbol, you can write <code>abc: "def"</code> instead of <code>:abc =&gt; "def"</code>. Similarly, <code>:abc =&gt; :def</code> and <code>abc: :def</code> are the same.</p>
<p>There are two tasks in the following example. Their names are “first” and “second”. “First” is a prerequisite for “second”.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a>task <span class="st">second: :first</span> <span class="kw">do</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a>  print <span class="st">&quot;Second.\n&quot;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a><span class="st">task: </span>first <span class="kw">do</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a>  print <span class="st">&quot;First.\n&quot;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>When you call the task “second”, the prerequiste “first” is invoked before the invocation of “second”.</p>
<pre><code>invoke first =&gt; invoke second</code></pre>
<p>Now, run rake. THe name of the above file is “Rakefile3”.</p>
<pre><code>$ rake -f Rakefile3 second
First.
Second.</code></pre>
<h4 id="rakefile-example">Rakefile example</h4>
<p>Utagawa-san’s <a href="https://blog.utgw.net/entry/2022/06/22/221311">Write a recipe for ajitama in a Makefile</a> was so interesting that I made a Rake version of it.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="co"># Make a &quot;ajitama&quot; (flavored egg)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a>task <span class="st">:Boil_hot_water</span> <span class="kw">do</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a>  print <span class="st">&quot;Boil water.\n&quot;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a>task <span class="dt">Boil_eggs</span>: <span class="st">:Boil_hot_water</span> <span class="kw">do</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a>  print <span class="st">&quot;Boil eggs.\n&quot;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true"></a>task <span class="st">:Wait_8_minutes</span> =&gt; <span class="st">:Boil_eggs</span> <span class="kw">do</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true"></a>  print <span class="st">&quot;Wait 8 minutes.\n&quot;</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true"></a>task <span class="dt">Add_ice_into_the_bowl</span>: <span class="st">:Wait_8_minutes</span> <span class="kw">do</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true"></a>  print <span class="st">&quot;Add ice to the bowl.\n&quot;</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true"></a>task <span class="dt">Fill_water_in_bowl</span>: <span class="st">:Add_ice_into_the_bowl</span> <span class="kw">do</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true"></a>  print <span class="st">&quot;Fill the bowl with water.\n&quot;</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true"></a>task <span class="dt">Put_the_eggs_in_the_bowl</span>: <span class="st">:Fill_water_in_bowl</span> <span class="kw">do</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true"></a>  print <span class="st">&quot;Put the eggs into the bowl.\n&quot;</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true"></a>task <span class="dt">Shell_the_eggs</span>: <span class="st">:Put_the_eggs_in_the_bowl</span> <span class="kw">do</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true"></a>  print <span class="st">&quot;Shell the eggs.\n&quot;</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true"></a>task <span class="st">:Write_the_date_on_the_ziplock</span> <span class="kw">do</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true"></a>  print <span class="st">&quot;Write the date on the ziplock.\n&quot;</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true"></a>task <span class="dt">Put_mentsuyu_into_a_ziplock</span>: [<span class="st">:Write_the_date_on_the_ziplock</span>, <span class="st">:Shell_the_eggs</span>] <span class="kw">do</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true"></a>  print <span class="st">&quot;Put mentsuyu (Japanese soup base) into a ziplock.\n&quot;</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true"></a></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true"></a>task <span class="dt">Put_the_eggs_in_a_ziplock</span>: <span class="st">:Put_mentsuyu_into_a_ziplock</span> <span class="kw">do</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true"></a>  print <span class="st">&quot;Put eggs in a ziplock.\n&quot;</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true"></a></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true"></a>task <span class="dt">Keep_it_in_the_fridge_one_night</span>: <span class="st">:Put_the_eggs_in_a_ziplock</span> <span class="kw">do</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true"></a>  print <span class="st">&quot;Keep it in the fridge one night.\n&quot;</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true"></a></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true"></a>task <span class="dt">Ajitama</span>: <span class="st">:Keep_it_in_the_fridge_one_night</span> <span class="kw">do</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true"></a>  print <span class="st">&quot;Ajitama is ready.\n&quot;</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Now run rake.</p>
<pre><code>$ rake -f Rakefile4 Ajitama
Write the date on the ziplock.
Boil water.
Boil eggs.
Wait 8 minutes.
Add ice to the bowl.
Fill the bowl with water.
Put the eggs into the bowl.
Shell the eggs.
Put mentsuyu (Japanese soup base) into a ziplock.
Put eggs in a ziplock.
Keep it in the fridge one night.
Ajitama is ready.</code></pre>
<h4 id="task-invocation-is-only-once">Task invocation is only once</h4>
<p>Tasks that have already been invoked doesn’t invoke their actions. In other words, tasks are invoked only once.</p>
<p>For example, if you change the ajitama’s Rakefile like this:</p>
<p>from:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a>task <span class="dt">Put_the_eggs_in_a_ziplock</span>: <span class="st">:Put_mentsuyu_into_a_ziplock</span> <span class="kw">do</span></span></code></pre></div>
<p>to:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a>task <span class="dt">Put_the_eggs_in_a_ziplock</span>: [<span class="st">:Put_mentsuyu_into_a_ziplock</span>, <span class="st">:Shell_the_eggs</span>] <span class="kw">do</span></span></code></pre></div>
<p>Then, <code>:Shell_the_eggs</code> is a prerequisite in the two different tasks. So, It is invoked twice, but the second invocation is ignored. And the result is the same as before.</p>
<blockquote>
<p>[R] The Task class has two instance methods “invoke” and “execute”. “Invoke” performs the action only once, while “execute” performs it as many times as the method is called. So, <a href="https://ruby.github.io/rake/doc/glossary_rdoc.html">Rake documentation</a> distinguishes the two words “call” and “execute”. There may be some ambiguous parts in this tutorial, but I don’t think they bring any big confusion. Note that “invoke” calls the prerequisites before performing its own task, but “execute” does not call the prerequisites.</p>
</blockquote>
<h4 id="strings-can-be-used-for-task-names-instead-of-symbols.">Strings can be used for task names instead of symbols.</h4>
<p>So far we’ve used symbols in task names, but you can also use strings.</p>
<pre><code>task &quot;simple_task&quot;
task &quot;second&quot; =&gt; &quot;first&quot;</code></pre>
<p>It is possible to write it like this. To describe a hash with a symbol, you can write something like “{abc: :def}”, but you can’t use this if the symbol starts with a number. “{0abc: :def}” and “{abc: :2def}” are syntax errors. It must be written like “{:‘0abc’ =&gt; :def}” and “{abc: :‘2def’}”. There is no such problems if you use strings.</p>
<p>The following format is often used.</p>
<pre><code>task abc: %w[def ghi]</code></pre>
<p><code>%w</code> returns an array of strings separated by spaces. <code>%w[def ghi]</code> and <code>["def", "ghi"]</code> are the same. Please refer to <a href="https://en.wikibooks.org/wiki/Ruby_Programming/Syntax/Literals#Alternate_Notation">The Ruby Programming Wikibook</a>.</p>
<p>If you use % notation in Ajitama Rakefile, it will be like this:</p>
<pre><code>task Put_mentsuyu_into_a_ziplock: %w[Write_the_date_on_the_ziplock Shell_the_eggs] do</code></pre>
<h3 id="file-task">File task</h3>
<p>File tasks are the most important tasks in Rake.</p>
<h4 id="what-is-file-task">What is File Task?</h4>
<p>A file task is a task but its name is a filename. A file task has a “name”, “prerequisites” and an “action” like a general task. There are three differences from general tasks:</p>
<ul>
<li>The “name” of the file task represents a path (of a file).</li>
<li>File tasks have conditions to perform their action or not.</li>
<li>A file task is defined with a “file” method while a general task is defined with a “task” method.</li>
</ul>
<p>Except for these things, file tasks behave like general tasks. For example, they invoke prerequisites before executing their action and they invoke their action only once.</p>
<p>There are two conditions to determine the invocation of file tasks.</p>
<ul>
<li>The file of the task does not exist.</li>
<li>The mtime (file content modification time) of the file of the task is older than the mtime of its prerequisites (at least one of them). However, if the prerequisite task is not a file task (if it is a general task), the current time is used instead of mtime. Therefore, if the prerequisites contain a general task, the file task action will always be invoked.</li>
</ul>
<blockquote>
<p>[R] The mtime (file content modification time) here is the value of Ruby’s File.mtime method. Linux files have three timestamps: atime, mtime and ctime.</p>
<ul>
<li>atime last access time</li>
<li>mtime last modified time</li>
<li>ctime last inode change time</li>
</ul>
<p>Ruby’s File.mtime method returns the mtime above. (The original Ruby written in C language gets its value with a C function.)</p>
</blockquote>
<h4 id="backup-files">Backup files</h4>
<p>I’d like to show you a simple example. It is to create a backup file “a.bak” for the text file “a.txt”. The easiest way is to use cp command.</p>
<pre><code>$ cp a.txt a.bak</code></pre>
<p>But I’d like to show you a Rakefile which performs the same thing.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a>file <span class="st">&quot;a.bak&quot;</span> =&gt; <span class="st">&quot;a.txt&quot;</span> <span class="kw">do</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a>  cp <span class="st">&quot;a.txt&quot;</span>, <span class="st">&quot;a.bak&quot;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>The contents of this Rakefile is:</p>
<ul>
<li><code>file</code> method defines a file task “a.bak”</li>
<li>The prerequisite for the task “a.bak” is “a.txt”.</li>
<li>The action of the task “a.bak” is <code>cp "a.txt", "a.bak"</code>.</li>
</ul>
<p>The cp method is a method that copies the first argument file to the second argument file. This method is defined in the FileUtils module. FileUtils is a standard Ruby library, but it’s not built-in, so you usually have to write <code>require 'fileutils'</code> in your program. But you don’t need to write it in your Rakefile as Rake automatically requires it.</p>
<p>When the task “a.bak” is called, the prerequisite “a.txt” is called before a.bak’s execution. However, the definition of the task “a.txt” is not written in the Rakefile. How does Rake behave when there are no task definitions? Rake defines a file task “a.txt” as a name-only task (no prerequisites and no action) if the file “a.txt” exists. Then it calls that task, but since it has no action, nothing happens and it returns to “a.bak”. If “a.txt” does not exist, an error will occur.</p>
<p>Now let’s run rake. Move your current directory to <code>example/example2</code> and type as follows.</p>
<pre><code>$ rake -f Rakefile1 a.bak
cp a.txt a.bak
$ diff a.bak a.txt
$ rake a.bak
$</code></pre>
<ul>
<li>When rake runs, “a.txt” is copied to “a.bak”.</li>
<li>When diff compares “a.bak” and “a.txt”, it doesn’t show any messages because the two files are exactly the same.</li>
<li>Run rake again, but no action is taken because the mtime of “a.bak” is newer than the one of “a.txt”</li>
</ul>
<p>Now you’ve learned the most basic file task here.</p>
<h4 id="backup-multiple-files">Backup multiple files</h4>
<p>I’d like to show you how to backup multiple files in this section. Create new files “b.txt” and “c.txt” in advance. The simplest Rakefile would be something like this:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a>file <span class="st">&quot;a.bak&quot;</span> =&gt; <span class="st">&quot;a.txt&quot;</span> <span class="kw">do</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true"></a>  cp <span class="st">&quot;a.txt&quot;</span>, <span class="st">&quot;a.bak&quot;</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true"></a>file <span class="st">&quot;b.bak&quot;</span> =&gt; <span class="st">&quot;b.txt&quot;</span> <span class="kw">do</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true"></a>  cp <span class="st">&quot;b.txt&quot;</span>, <span class="st">&quot;b.bak&quot;</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true"></a>file <span class="st">&quot;c.bak&quot;</span> =&gt; <span class="st">&quot;c.txt&quot;</span> <span class="kw">do</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true"></a>  cp <span class="st">&quot;c.txt&quot;</span>, <span class="st">&quot;c.bak&quot;</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>There are three file tasks defined here. This Rakefile has been saved as <code>example/example2/Rakefile2</code>. Delete “a.bak” and run rake like this:</p>
<pre><code>$ rm a.bak
$ rake -f Rakefile2 a.bak
cp a.txt a.bak
$ rake -f Rakefile2 b.bak
cp b.txt b.bak
$ rake -f Rakefile2 c.bak
cp c.txt c.bak
$ ls | grep .bak
a.bak
b.bak
c.bak</code></pre>
<p>Maybe you would say:</p>
<p>“If I were you, I wouldn’t do this. Using rake three times is the same as using cp three times.”</p>
<p>You are right. I also don’t want to run rake three times. I want to run rake once and copy all 3 files. This can be achieved by associating a general task with three file tasks. Let’s start by creating a “copy” task, which has the three file tasks as its prerequisites.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true"></a>task <span class="st">copy: </span><span class="ot">%w[</span><span class="st">a.bak b.bak c.bak</span><span class="ot">]</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true"></a>file <span class="st">&quot;a.bak&quot;</span> =&gt; <span class="st">&quot;a.txt&quot;</span> <span class="kw">do</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true"></a>  cp <span class="st">&quot;a.txt&quot;</span>, <span class="st">&quot;a.bak&quot;</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true"></a>file <span class="st">&quot;b.bak&quot;</span> =&gt; <span class="st">&quot;b.txt&quot;</span> <span class="kw">do</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true"></a>  cp <span class="st">&quot;b.txt&quot;</span>, <span class="st">&quot;b.bak&quot;</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true"></a>file <span class="st">&quot;c.bak&quot;</span> =&gt; <span class="st">&quot;c.txt&quot;</span> <span class="kw">do</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true"></a>  cp <span class="st">&quot;c.txt&quot;</span>, <span class="st">&quot;c.bak&quot;</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>This Rakefile has been saved as <code>example/example2/Rakefile3</code>. Try it.</p>
<pre><code>$ rm *.bak
$  rake -f Rakefile3 copy
cp a.txt a.bak
cp b.txt b.bak
cp c.txt c.bak</code></pre>
<p>I got 3 backup files at once.</p>
<p>Now restructure the Rakefile. It includes the following two:</p>
<ul>
<li>Change the top level task from “copy” to “default”. “Default” is the default task when rake’s command line argument is left out.</li>
<li>Combine 3 file methods into a Ruby iterator’s block.</li>
</ul>
<div class="sourceCode" id="cb30"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true"></a>backup_files =<span class="ot"> %w[</span><span class="st">a.bak b.bak c.bak</span><span class="ot">]</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true"></a>task <span class="st">default: </span>backup_files</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true"></a>backup_files.each <span class="kw">do</span> |backup|</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true"></a>  source = backup.ext(<span class="st">&quot;.txt&quot;</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true"></a>  file backup =&gt; source <span class="kw">do</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true"></a>    cp source, backup</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true"></a>  <span class="kw">end</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<ul>
<li>First, create an array of backup files and assign it to the variable <code>backup_files</code>.</li>
<li>Declare the top level task “default”.</li>
<li>Use the each method to get each element of the backup file array. The element is assigned to the <code>backup</code> parameter of the block.</li>
<li>Substitute the backup’s extension from “.bak” to “.txt” and assign it to the variable <code>source</code>. The “ext” method is a method added to the String class by rake. The original String class does not have “ext” method.</li>
<li>Define a file task with the <code>file</code> command. The iterator “each” repeats the block three times, so the <code>file</code> command is executed also three times. Then, three file tasks “a.bak”, “b.bak” and “c.bak” will be defined.</li>
</ul>
<p>This Rakefile has been saved as <code>example/example2/Rakefile4</code>. Now, give it a try.</p>
<pre><code>$ rm *.bak
$ rake -f Rakefile4
cp a.txt a.bak
cp b.txt b.bak
cp c.txt c.bak
$ touch a.txt
$rake -f Rakefile4
cp a.txt a.bak
$</code></pre>
<ul>
<li>Delete all backup files</li>
<li>Running rake will copy all three files.</li>
<li>Touch “a.txt” to update the mtime of “a.txt”.</li>
<li>When you run rake again, the action of the file task “a.bak” is executed because the mtime of “a.txt” is newer than the mtime of “a.bak”. No other action is executed because the other backup files have newer mtime than the original files.</li>
</ul>
<p>I used “touch” to change the mtime, but usually mtime is updated when the file is updated with an editor. In other words, when the original file is updated, the file task action will be executed.</p>
<p>Let’s refactor the rakefile a little to show how to use task instances inside blocks.</p>
<p>Change the file task definition to:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true"></a>file backup =&gt; source <span class="kw">do</span> |t|</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true"></a>  cp t.source, t.name</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>The block now has a new parameter “t”, which the file task “backup” is assigned to. The “backup” task is an instance of the Task class from the Ruby syntax’s point of view.</p>
<p>The same parameters can be used in blocks of task methods.</p>
<p>Tasks and file tasks, which are instances of the Task class, have convenience methods.</p>
<ul>
<li><code>name</code> returns the name of the task.</li>
<li><code>prerequisites</code> returns an array of prerequisites.</li>
<li><code>sources</code> returns a list of files that the task depends on.</li>
<li><code>source</code> returns the first element of <code>sources</code>.</li>
</ul>
<p>There are some other methods, but the four methods above are the most commonly used.</p>
<p>In the new file task definition, its action has changed to copy from ‘t.source’ to ‘t.name’. This will be “source” and “backup” respectively, so it is the same as the previous file task.</p>
<p>The new file has been saved as <code>example/example2/Rakefile5</code>.</p>
<pre><code>$ rm *.bak
$ rake -f Rakefile5
cp a.txt a.bak
cp b.txt b.bak
cp c.txt c.bak</code></pre>
<h4 id="rules">Rules</h4>
<p>The actions of the tasks were copying files with the “.txt” extension to files with the “.bak” extension. If you apply this to the file “a.bak”, you will get a file task with the action “copy a.txt to a.bak”. These way how to create file tasks are called rules. Rules can be defined with the “rule” method. Let’s take a look at an example.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true"></a>backup_files =<span class="ot"> %w[</span><span class="st">a.bak b.bak c.bak</span><span class="ot">]</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true"></a>task <span class="st">default: </span>backup_files</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true"></a>rule <span class="st">&#39;.bak&#39;</span> =&gt; <span class="st">&#39;.txt&#39;</span> <span class="kw">do</span> |t|</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true"></a>  cp t.source, t.name</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>The first three lines are the same as before. According to the definition on the third line, the prerequisites of the task “default” are “a.bak”, “b.bak” and “c.bak”. But those tasks are not declared. In that case, rake will try to define the file task when the prerequisite is invoked.</p>
<ul>
<li>If a rule is defined and the task name matches the rule, rake defines the task with the rule.</li>
<li>if no rule matches and the task name matches an existing filename, rake defines a file task with the task name but no prerequisites and action.</li>
<li>if none of the above, an error occurs.</li>
</ul>
<p>The rule in this example looks like this:</p>
<ul>
<li>Task name extension is “.bak”</li>
<li>The extension of the dependent file name is “.txt”</li>
<li>The action is to copy <code>t.source</code> (the first element in the array of files that the task depends on) to <code>t.name</code> (task name = file name).</li>
</ul>
<p>All three tasks “a.bak”, “b.bak” and “c.bak” match the rule, so the task is defined according to the rule.</p>
<p>The Rakefile above has been saved as <code>example/example2/Rakefile6</code>.</p>
<pre><code>$ rm *.bak
$ rake -f Rakefile6
cp a.txt a.bak
cp b.txt b.bak
cp c.txt c.bak
$</code></pre>
<p>It worked the same as before.</p>
<p>The “.bak” part of the rule method is converted by Rake to a regular expression <code>/\.bak$/</code>. And the regular expression is compared with the task names ‘a.bak’, ‘b.bak’ and ‘c.bak’. You can use regular expressions for the task name of the rule instead of string from the very first.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true"></a>rule <span class="ot">/\.bak$/</span> =&gt; <span class="st">&#39;.txt&#39;</span> <span class="kw">do</span> |t|</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true"></a>  cp t.source, t.name</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Run rake with <code>Rakefile7</code>.</p>
<pre><code>$ rm *.bak
$ rake -f Rakefile7
cp a.txt a.bak
cp b.txt b.bak
cp c.txt c.bak
$</code></pre>
<blockquote>
<p>[R] Regular expression enables the pattern to match an arbitrary patterns as well as extensions. For example, it is possible to change the backup filename to include a tilde “<code>~</code>” at the beginning, such as “~a.txt”.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true"></a>backup_files =<span class="ot"> %w[</span><span class="st">~a.txt ~b.txt ~c.txt</span><span class="ot">]</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true"></a>task <span class="st">default: </span>backup_files</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true"></a>rule <span class="ot">/^~.*\.txt$/</span> =&gt; <span class="st">&#39;.txt&#39;</span> <span class="kw">do</span> |t|</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true"></a>cp t.source, t.name</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>But this Rakefile doesn’t work.</p>
<pre><code>$ rake
rake aborted!
Rake::RuleRecursionOverflowError: Rule Recursion Too Deep: [~a.txt =&gt; ~a.txt =&gt; ~a.txt =&gt; ~a.txt =&gt; ~a.txt =&gt; ~a.txt =&gt; ~a .txt =&gt; ~a.txt =&gt; ~a.txt =&gt; ~a.txt =&gt; ~a.txt =&gt; ~a.txt =&gt; ~a.txt =&gt; ~a.txt =&gt; ~a.txt =&gt; ~a.txt =&gt; ~a.txt]

Tasks: TOP =&gt; default
(See full trace by running task with --trace)</code></pre>
<p>This is because the <code>=&gt; '.txt'</code> part. The filename “~a.txt” matches the rule again, so rake try to apply the rule to “~a.txt”. In other words, the task name and the dependent task name are the same, so we end up in an infinite loop when applying the rule. Rake decides it an error at the 16th loop.</p>
<p>To avoid this, define the dependent file with a Proc object.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true"></a>backup_files =<span class="ot"> %w[</span><span class="st">~a.txt ~b.txt ~c.txt</span><span class="ot">]</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true"></a>task <span class="st">default: </span>backup_files</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true"></a>rule <span class="ot">/^~.*\.txt$/</span> =&gt; proc {|tn| tn.sub(<span class="ot">/^~/</span>,<span class="st">&quot;&quot;</span>)} <span class="kw">do</span> |t|</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true"></a>cp t.source, t.name</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>The task name (e.g. “~a.txt”) is passed by Rake as an argument to the proc method block. You can use the lambda method or “-&gt;( ){ }” instead of proc method. See <a href="https://docs.ruby-lang.org/en/master/syntax/literals_rdoc.html#label-Lambda+Proc+Literals">Ruby documentation</a>.</p>
<pre><code>$ rm ~*
$ rake -f Rakefile8
cp a.txt ~a.txt
cp b.txt ~b.txt
cp c.txt ~c.txt
$</code></pre>
<h3 id="filelist-pathmap-and-directory-task">FileList, Pathmap and Directory Task</h3>
</blockquote>
<p>This section describes useful features that support file tasks. Specifically, they are “FileList”, “pathmap” and “directory task”.</p>
<h4 id="filelist">FileList</h4>
<p>FileList is an array-like object of filenames. It can be manipulated like an array of strings and has some nice features.</p>
<p>Let’s start with the way how to create an instance of the class FileList. Add <code>[ ]</code> to the class name “FileList”, and write the file names in the brackets separated by commas. Now you have a FileList instance with the files.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true"></a>files = <span class="dt">FileList</span>[<span class="st">&quot;a.txt&quot;</span>, <span class="st">&quot;b.txt&quot;</span>]</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true"></a>p files</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true"></a>task<span class="st">:default</span></span></code></pre></div>
<p>If you don’t define a default task, you will get an error when you run rake from the command line. I have defined a default task that does nothing to avoid that.</p>
<p>Now let’s see how rake works.</p>
<ol type="1">
<li>Initialize the rake environment</li>
<li>Load the Rakefile. The Rakefile is then executed (as Ruby code)</li>
<li>Call default task</li>
</ol>
<p>On the second, Rakefile is loaded and executed. Then a FileList instance is created, displayed, and the default task defined. Note that these are done before the default task invocation.</p>
<p>The Rakefile above has been saved as <code>example/example3/Rakefile1</code>.</p>
<pre><code>$ rake -f Rakefile1
[&quot;a.txt&quot;, &quot;b.txt&quot;]
$</code></pre>
<p>You can also use the glob pattern commonly used in Bash.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true"></a>files = <span class="dt">FileList</span>[<span class="st">&quot;*.txt&quot;</span>]</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true"></a>p files</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true"></a>task<span class="st">:default</span></span></code></pre></div>
<p>This Rakdfile is <code>example/example3/Ralefile2</code>.</p>
<pre><code>$ rm d.txt
$ ls
 Rakefile1   Rakefile4   Rakefile7   a.txt   dst
 Rakefile2   Rakefile5   Rakefile8   b.txt   src
 Rakefile3   Rakefile6   Rakefile9   c.txt  &#39;~a.txt&#39;
$ rake -f Rakefile2
[&quot;a.txt&quot;, &quot;b.txt&quot;, &quot;c.txt&quot;, &quot;~a.txt&quot;]
$</code></pre>
<p>Please refer to the <a href="https://docs.ruby-lang.org/en/master/Dir.html#method-c-glob">Ruby documentation</a> for glob patterns.</p>
<h4 id="backup-all-text-files">Backup all text files</h4>
<p>Let’s think about the way to back up all the text files. Here, “text file” is a file with “.txt” extension. Note that “all the text files” are determined at the time rake runs not the time you write the Rakefile. Text files may be added or removed , so “all text files at the moment” is not necessarily the same as “all text files at the time rake runs”. So you have to create a mechanism in the Rakefile to get text files.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true"></a>files = <span class="dt">FileList</span>[<span class="st">&quot;*.txt&quot;</span>]</span></code></pre></div>
<p>When this line is executed, ruby gets files that match “*.txt”. The files include “~a.txt”. But it should be excluded since it is a backup file whose original is “a.txt”. Exclude method is the one you need.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true"></a>files = <span class="dt">FileList</span>[<span class="st">&quot;*.txt&quot;</span>]</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true"></a>files.exclude(<span class="st">&quot;~*.txt&quot;</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true"></a>p files</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true"></a>task<span class="st">:default</span></span></code></pre></div>
<p>The exclude method adds the given pattern to its own exclusion list.</p>
<pre><code>$ rake -f Rakefile3
[&quot;a.txt&quot;, &quot;b.txt&quot;, &quot;c.txt&quot;]
$</code></pre>
<p>“~a.txt” has been removed from <code>files</code>.</p>
<p>The variable <code>files</code> is now set to the file list of the original files. On the other hand, the name of the file task is the backup file name. For example, in a file task that copies “a.txt” to “a.bak”,</p>
<ul>
<li>Task name is “a.bak”</li>
<li>Dependent file name is “a.txt”</li>
</ul>
<p>In order to define a file task, it is necessary to obtain the task name (destination filename) from the source filename. To do so, use the ext method of FileList class. The ext method changes the extension of all files included in the file list.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true"></a>names = sources.ext(<span class="st">&quot;.bak&quot;</span>)</span></code></pre></div>
<p>The Rakefile is like this.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true"></a>sources = <span class="dt">FileList</span>[<span class="st">&quot;*.txt&quot;</span>]</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true"></a>sources.exclude(<span class="st">&quot;~*.txt&quot;</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true"></a>names = sources.ext(<span class="st">&quot;.bak&quot;</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true"></a>task <span class="st">default: </span>names</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true"></a></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true"></a>rule <span class="st">&quot;.bak&quot;</span> =&gt; <span class="st">&quot;.txt&quot;</span> <span class="kw">do</span> |t|</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true"></a>  cp t.source, t.name</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>This file has been saved as <code>example/example3/Rakefile4</code>.</p>
<pre><code>$rake -f Rakefile4
cp a.txt a.bak
cp b.txt b.bak
cp c.txt c.bak
$</code></pre>
<p>Now add a text file and run rake again.</p>
<pre><code>$ echo Appended text file. &gt;d.txt
$ rm *.bak
$ rake -f Rakefile4
cp a.txt a.bak
cp b.txt b.bak
cp c.txt c.bak
cp d.txt d.bak
$</code></pre>
<p>A new file “d.txt” has been also copied. This means that Rakefile makes backup files of “all text files” at the time Rake runs.</p>
<p>The “*.txt” file in this example is sometimes referred to as the sources and the “*.bak” files as the targets. In general, it can be said that the source exists, but the target does not necessarily exist. Therefore, source files is often get first and then the target filenames are created from the source in Rakefile.</p>
<h4 id="pathmap">Pathmap</h4>
<p>The pathmap method is a powerful method for FileList. Originally pathmap was an instance method of the String object. The FileList’s pathmap method performs String’s pathmap for each element of the FileList. Pathmap returns various information depending on its arguments. Here are some examples.</p>
<ul>
<li>%p =&gt; Represents the full path</li>
<li>%f =&gt; Represents the filename with extension. It does not contain the directory name.</li>
<li>%n =&gt; Represents the filename without extension.</li>
<li>%d =&gt; Represents a list of directories in the path.</li>
</ul>
<p>In advance, create a “src” directory in the current directory and create “a.txt”, “b.txt” and “c.txt” under it.</p>
<pre><code>$ mkdir src
$ touch src/a.txt src/b.txt src/c.txt
$ tree
.
├── Rakefile
├── a.bak
├── a.txt
├── b.bak
├── b.txt
├── c.bak
├── c.txt
├── d.bak
├── d.txt
├── src
│   ├── a.txt
│   ├── b.txt
│   └── c.txt
└── ~a.txt

1 directory, 14 files
$</code></pre>
<p>Write your Rakefile like this:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true"></a>sources = <span class="dt">FileList</span>[<span class="st">&quot;src/*.txt&quot;</span>]</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true"></a>p sources.pathmap(<span class="st">&quot;%p&quot;</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true"></a>p sources.pathmap(<span class="st">&quot;%f&quot;</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true"></a>p sources.pathmap(<span class="st">&quot;%n&quot;</span>)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true"></a>p sources.pathmap(<span class="st">&quot;%d&quot;</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true"></a>task<span class="st">:default</span></span></code></pre></div>
<p>The variable <code>sources</code> contains “src/a.txt”, “src/b.txt” and “src/c.txt”. Execute rake.</p>
<pre><code>$ rake -f Rakefile5
[&quot;src/a.txt&quot;, &quot;src/b.txt&quot;, &quot;src/c.txt&quot;]
[&quot;a.txt&quot;, &quot;b.txt&quot;, &quot;c.txt&quot;]
[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]
[&quot;src&quot;, &quot;src&quot;, &quot;src&quot;]</code></pre>
<p>The pathmap method allows you to specify a pattern and its replacement delimited by a comma and enclose them in curly braces. The replacement specification is placed between the % and the directive. For example, “%{src,dst}p” returns the pathname with “src” replaced by “dst”. This can be used to get the “task name” from the “dependent file name”.</p>
<p>The following Rakefile copies all text files under the src directory to the dst directory.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true"></a>sources = <span class="dt">FileList</span>[<span class="st">&quot;src/*.txt&quot;</span>]</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true"></a>names = sources.pathmap(<span class="st">&quot;%{src,dst}p&quot;</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true"></a>task <span class="st">default: </span>names</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true"></a></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true"></a>mkdir <span class="st">&quot;dst&quot;</span> <span class="kw">unless</span> <span class="dt">Dir</span>.exist?(<span class="st">&quot;dst&quot;</span>)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true"></a>names.each <span class="kw">do</span> |name|</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true"></a>  source = name.pathmap(<span class="st">&quot;%{dst,src}p&quot;</span>)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true"></a>  file name =&gt; source <span class="kw">do</span> |t|</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true"></a>    cp t.source, t.name</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true"></a>  <span class="kw">end</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>The second line uses the path map replacement specification.</p>
<ul>
<li><code>sources</code> is an array <code>["src/a.txt", "src/b.txt", "src/c.txt"]</code></li>
<li><code>names</code> will be an array <code>["dst/a.txt", "dst/b.txt", "dst/c.txt"]</code></li>
</ul>
<p>Line 6 creates the destination directory “dst” if it does not exist. The <code>mkdir</code> method is defined in the FileUtils module, which Rake automatically requires. Line 8 uses the string pathmap method to get the dependency filename from the task name.</p>
<ul>
<li><code>name</code> is <code>dst/a.txt</code>, <code>dst/b.txt</code> or <code>dst/c.txt</code></li>
<li><code>source</code> will be <code>src/a.txt</code>, <code>src/b.txt</code> or <code>src/c.txt</code></li>
</ul>
<p>Execute rake with <code>example/example3/Rakefile6</code>.</p>
<pre><code>$ rm -rf dst
$ rake -f Rakefile6
mkdir dst
cp src/a.txt dst/a.txt
cp src/b.txt dst/b.txt
cp src/c.txt dst/c.txt
$</code></pre>
<blockquote>
<p>[R] You can also use a rule that uses a regular expression and Proc object.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true"></a>sources = <span class="dt">FileList</span>[<span class="st">&quot;src/*.txt&quot;</span>]</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true"></a>names = sources.pathmap(<span class="st">&quot;%{src,dst}p&quot;</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true"></a>task <span class="st">default: </span>names</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true"></a>mkdir <span class="st">&quot;dst&quot;</span> <span class="kw">unless</span> <span class="dt">Dir</span>.exist?(<span class="st">&quot;dst&quot;</span>)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true"></a></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true"></a>rule <span class="ot">/^dst\/.*\.txt$/</span> =&gt; proc {|tn| tn.pathmap(<span class="st">&quot;%{dst,src}p&quot;</span>)} <span class="kw">do</span> |t|</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true"></a>cp t.source, t.name</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Execute rake with <code>example/example3/Rakefile7</code>)</p>
<pre><code>$ rm dst/*
$ rake -f Rakefile7
cp src/a.txt dst/a.txt
cp src/b.txt dst/b.txt
cp src/c.txt dst/c.txt
$</code></pre>
<p>Using a rule is simpler than an iterator.</p>
</blockquote>
<h4 id="directory-task">Directory Task</h4>
<p>The <code>directory</code> method creates a directory task. A directory task creates a directory with the task name if it does not exist.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true"></a>directory <span class="st">&quot;a/b/c&quot;</span></span></code></pre></div>
<p>This directory task creates a directory “a/b/c”. If the parents directories b and a don’t exist, create them too.</p>
<p>You can also use this to create the dst directory.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true"></a>sources = <span class="dt">FileList</span>[<span class="st">&quot;src/*.txt&quot;</span>]</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true"></a>names = sources.pathmap(<span class="st">&quot;%{src,dst}p&quot;</span>)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true"></a>task <span class="st">default: </span>names</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true"></a>directory <span class="st">&quot;dst&quot;</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true"></a>names.each <span class="kw">do</span> |name|</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true"></a>  source = name.pathmap(<span class="st">&quot;%{dst,src}p&quot;</span>)</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true"></a>  file name =&gt; [source, <span class="st">&quot;dst&quot;</span>] <span class="kw">do</span> |t|</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true"></a>    cp t.source, t.name</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true"></a>  <span class="kw">end</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Note that directory tasks are “tasks”, so they are just defined during the Rakefile are loaded and executed. The tasks need to be invoked by another task. So, add ‘dst’ to the prerequisite for <code>dst/a.txt</code>, <code>dst/b.txt</code> and <code>dst/c.txt</code>. This makes the directory before copying.</p>
<p>Execute rake with <code>-f Rakefile8</code>.</p>
<pre><code>$ rm dst/*
$ rake -f Rakefile8
cp src/a.txt dst/a.txt
cp src/b.txt dst/b.txt
cp src/c.txt dst/c.txt
$</code></pre>
<blockquote>
<p>[R] Rewrite the Rakefile with a rule.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true"></a>sources = <span class="dt">FileList</span>[<span class="st">&quot;src/*.txt&quot;</span>]</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true"></a>names = sources.pathmap(<span class="st">&quot;%{src,dst}p&quot;</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true"></a>task <span class="st">default: </span>names</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true"></a>directory <span class="st">&quot;dst&quot;</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true"></a></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true"></a>rule <span class="ot">/^dst\/.*\.txt$/</span> =&gt; [proc {|tn| tn.pathmap(<span class="st">&quot;%{dst,src}p&quot;</span>)}, <span class="st">&quot;dst&quot;</span>] <span class="kw">do</span> |t|</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true"></a>cp t.source, t.name</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>A directory task has been added to the rule’s prerequisites.</p>
</blockquote>
<h3 id="a-useful-example-of-rakefile-1-clean-and-clobber">A useful example of Rakefile (1), Clean and Clobber</h3>
<p>In this section we will combine Pandoc and Rake to create an HTML file. Clean and Clobber will be also explained.</p>
<h4 id="pandoc">Pandoc</h4>
<p>Pandoc is an application that converts among lots of document formats. for example,</p>
<ul>
<li>MS Word into HTML</li>
<li>Markdown into PDF</li>
</ul>
<p>Many other document formats are also supported. For further information, see the <a href="https://pandoc.org/">Pandoc website</a>.</p>
<p>Pandoc is executed from the command line.</p>
<pre><code>pandoc -o destination_file source_file</code></pre>
<p>The option <code>-o</code> tells a destination file to pandoc. Pandoc determines the file format from the extensions both source and destination.</p>
<p>In the following example, a word file <code>example.docx</code> is converted into a HTML file. The word file looks like this:</p>
<div style="text-align:center;">
<p><img src="word.png" alt="Word screen" style="max-width:100%;"></p>
</div>
<p>Now convert it into an HTML file. Pandoc is executed with <code>-s</code> option, which I will explain later.</p>
<pre><code>$ pandoc -so example.html example.docx</code></pre>
<p>This will create a file <code>example.html</code>. Double-click to display it in a browser.</p>
<div style="text-align:center;">
<p><img src="html.png" alt="HTML screen" style="max-width:100%;"></p>
</div>
<p>The same contents as the one in Word are displayed. The HTML is as follows.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true"></a><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true"></a><span class="kw">&lt;html</span><span class="ot"> xmlns=</span><span class="st">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="ot"> lang=</span><span class="st">&quot;&quot;</span><span class="ot"> xml:lang=</span><span class="st">&quot;&quot;</span><span class="kw">&gt;</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true"></a><span class="kw">&lt;head&gt;</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true"></a>  <span class="kw">&lt;meta</span><span class="ot"> charset=</span><span class="st">&quot;utf-8&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true"></a>  <span class="kw">&lt;meta</span><span class="ot"> name=</span><span class="st">&quot;generator&quot;</span><span class="ot"> content=</span><span class="st">&quot;pandoc&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true"></a>  <span class="kw">&lt;meta</span><span class="ot"> name=</span><span class="st">&quot;viewport&quot;</span><span class="ot"> content=</span><span class="st">&quot;width=device-width, initial-scale=1.0, user-scalable=yes&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true"></a>  <span class="kw">&lt;title&gt;</span>example<span class="kw">&lt;/title&gt;</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true"></a>  ... ... ...</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true"></a>  ... ... ...</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true"></a><span class="kw">&lt;/head&gt;</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true"></a><span class="kw">&lt;h1</span><span class="ot"> id=</span><span class="st">&quot;pandoc-installation&quot;</span><span class="kw">&gt;</span>Pandoc installation<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true"></a><span class="kw">&lt;p&gt;</span>Use apt-get to install Pandoc from your distribution packages.<span class="kw">&lt;/p&gt;</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true"></a><span class="kw">&lt;p&gt;</span>$ sudo apt-get install pandoc<span class="kw">&lt;/p&gt;</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true"></a><span class="kw">&lt;p&gt;</span>The Pandoc distribution package is usually not the latest version. If</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true"></a>you want to get the latest one, download it from the Pandoc web</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true"></a>page.<span class="kw">&lt;/p&gt;</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true"></a><span class="kw">&lt;h1</span><span class="ot"> id=</span><span class="st">&quot;ruby-installation&quot;</span><span class="kw">&gt;</span>Ruby installation<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true"></a><span class="kw">&lt;p&gt;</span>Use apt-get.<span class="kw">&lt;/p&gt;</span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true"></a><span class="kw">&lt;p&gt;</span>$ sudo apt-get install ruby<span class="kw">&lt;/p&gt;</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true"></a><span class="kw">&lt;p&gt;</span>If you want to get the latest version, use Rbenv. See Rbenv and</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true"></a>ruby-build GitHub pages.<span class="kw">&lt;/p&gt;</span></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true"></a><span class="kw">&lt;/body&gt;</span></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>One important thing is that a header has been added. This is because you gave pandoc the <code>-s</code> option. Without <code>-s</code>, only the part between the body tags will be generated.</p>
<h4 id="preparation-for-pandoc">Preparation for Pandoc</h4>
<p>This section describes how to convert markdown to HTML and automate the work with Rake.</p>
<p>Assume all source files are in the current directory. The generated HTML will be created in the docs directory. The markdown files are “sec1.md”, “sec2.md”, “sec3.md” and “sec4.md”.</p>
<p>The example files are in <code>example/example4</code>.</p>
<p>In Pandoc markdown, we write metadata with % first. This represents the title, author and date.</p>
<pre><code>% Getting started with Rake
% Toshio CP
% August 5, 2022</code></pre>
<p>The title will be put in the <code>title</code> tag in the HTML header.</p>
<p>PC screen width is usually too big to read a document so it is appropriate to put a CSS to make the width shorter.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode css"><code class="sourceCode css"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true"></a>body {</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true"></a>  <span class="kw">padding-right</span>: <span class="dv">0.75</span><span class="dt">rem</span><span class="op">;</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true"></a>  <span class="kw">padding-left</span>: <span class="dv">0.75</span><span class="dt">rem</span><span class="op">;</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true"></a>  <span class="kw">margin-right</span>: <span class="bu">auto</span><span class="op">;</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true"></a>  <span class="kw">margin-left</span>: <span class="bu">auto</span><span class="op">;</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true"></a>}</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true"></a><span class="im">@media</span> (<span class="kw">min-width</span>: <span class="dv">576</span><span class="dt">px</span>) {</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true"></a>  body {</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true"></a>    <span class="kw">max-width</span>: <span class="dv">540</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true"></a>  }</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true"></a>}</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true"></a><span class="im">@media</span> (<span class="kw">min-width</span>: <span class="dv">768</span><span class="dt">px</span>) {</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true"></a>  body {</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true"></a>    <span class="kw">max-width</span>: <span class="dv">720</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true"></a>  }</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true"></a>}</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true"></a><span class="im">@media</span> (<span class="kw">min-width</span>: <span class="dv">992</span><span class="dt">px</span>) {</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true"></a>  body {</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true"></a>    <span class="kw">max-width</span>: <span class="dv">960</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true"></a>  }</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true"></a>}</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true"></a><span class="im">@media</span> (<span class="kw">min-width</span>: <span class="dv">1200</span><span class="dt">px</span>) {</span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true"></a>  body {</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true"></a>    <span class="kw">max-width</span>: <span class="dv">1140</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true"></a>  }</span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true"></a>}</span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true"></a><span class="im">@media</span> (<span class="kw">min-width</span>: <span class="dv">1400</span><span class="dt">px</span>) {</span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true"></a>  body {</span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true"></a>    <span class="kw">max-width</span>: <span class="dv">1320</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true"></a>  }</span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true"></a>}</span></code></pre></div>
<p>I wrote this CSS while referencing the Bootstrap’s container class.</p>
<p>This CSS adjusts the width of <code>body</code> according to the screen size. It’s a technique called responsive web design (RWD). You can get more information if you search for “responsive web design” in the internet.</p>
<p>Save this as <code>style.css</code> in the top directory, where you put your Rakefile. The option <code>-c style.css</code> make pandoc include the stylesheet file in the header of the HTML.</p>
<h4 id="rakefile">Rakefile</h4>
<p>A Rakefile creates an HTML from the four files “sec1.md” to “sec4.md”. The target HTML and “style.css” will be located under <code>docs</code> directory.</p>
<p>There are two possible ways.</p>
<ul>
<li>Each markdown file is converted to HTML file. Another HTML file (top page) has a table of contents that has links to each HTML file.</li>
<li>Concatenate the markdown files into one file, then convert it to HTML.</li>
</ul>
<p>Both have advantages and disadvantages. This tutorial takes the second way because it’s easier than the first.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true"></a>sources = <span class="dt">FileList</span>[<span class="st">&quot;sec*.md&quot;</span>]</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true"></a>task <span class="st">default: </span><span class="ot">%w[</span><span class="st">docs/LearningRake.html docs/style.css</span><span class="ot">]</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true"></a>file <span class="st">&quot;docs/LearningRake.html&quot;</span> =&gt;<span class="ot"> %w[</span><span class="st">LearningRake.md docs</span><span class="ot">]</span> <span class="kw">do</span> |t|</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true"></a>  sh <span class="st">&quot;pandoc -s --toc -c style.css -o </span><span class="ot">#{</span>t.name<span class="ot">}</span><span class="st"> </span><span class="ot">#{</span>t.source<span class="ot">}</span><span class="st">&quot;</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true"></a></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true"></a>file <span class="st">&quot;LearningRake.md&quot;</span> =&gt; sources <span class="kw">do</span> |t|</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true"></a>  lerning_rake = t.sources.inject(<span class="st">&quot;&quot;</span>) {|s1, s2| s1 &lt;&lt; <span class="dt">File</span>.read(s2) + <span class="st">&quot;\n&quot;</span>}</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true"></a>  <span class="dt">File</span>.write(<span class="st">&quot;LearningRake.md&quot;</span>, lerning_rake)</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true"></a></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true"></a>file <span class="st">&quot;docs/style.css&quot;</span> =&gt;<span class="ot"> %w[</span><span class="st">style.css docs</span><span class="ot">]</span> <span class="kw">do</span> |t|</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true"></a>  cp t.source, t.name</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true"></a></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true"></a>directory <span class="st">&quot;docs&quot;</span></span></code></pre></div>
<p>Task relationships are a bit complicated. Let’s look at them one by one.</p>
<ul>
<li>The prerequisites of <code>default</code> are <code>docs/LearningRake.html</code> and <code>docs/style.css</code>.</li>
<li><code>docs/LearningRake.html</code> depends on <code>LearningRake.md</code> and a directory <code>docs</code>.</li>
<li><code>LearningRake.md</code> depends on 4 files (<code>sec1.md</code> to <code>sec4.md</code>).</li>
<li><code>docs/style.css</code> depends on <code>style.css</code> and the directory <code>docs</code>.</li>
<li><code>docs</code> is a directory task, defined with the directory method.</li>
</ul>
<p>There is <code>sh</code> method in line 6. It is similar to Ruby’s <code>system</code> method and executes the argument as an external command. It invokes Pandoc via <code>bash</code> on line 6. The <code>sh</code> method is a Rake extension to FileUtils class.</p>
<p>Pandoc option <code>--toc</code> automatically generates a table of contents. By default, Markdown headings from <code>#</code> to <code>###</code> will be put in the table of contents.</p>
<p>The <code>inject</code> method on line 10 is the array instance method. The argument (an empty string) is the initial value of <code>s1</code>. The values ​​in the array are sequentially assigned to <code>s2</code> and calculated, and the result is assigned to the next <code>s1</code>. See how the method works step by step.</p>
<ul>
<li>The initial value is the empty string <code>""</code> (the argument). it is assigned to <code>s1</code> in the block.</li>
<li><code>s2</code> is assigned the first array element, “sec1.md”, and <code>s1 &lt;&lt; File.read(s2) + "\n"</code> is executed. As a result, “contents of sec1.md + newline” is added to the string pointed to by <code>s1</code>, and that string becomes the return value of the <code>&lt;&lt;</code> method. The return value will be assigned to <code>s1</code> in the block when it is executed in the second time. (The actual proces is complicated, but in short, it can be said that <code>s1</code> is added with “contents of sec1.md + newline” and becomes the next <code>s1</code>.)</li>
<li>In the second block execution, <code>s1</code> is substituted with “sec1.md contents + newline”, and <code>s2</code> is substituted with the next array element “sec2.md”. The block is executed, and “sec2.md contents + newline” is added to <code>s1</code>. As a result, <code>s1</code> becomes “contents of sec1.md + newline + content of sec2.md + newline”. This will be assigned to the next <code>s1</code>.</li>
<li>In the third execution of the block, the result of the previous execution is assigned to <code>s1</code>, and the next array element “sec3.md” is assigned to <code>s2</code>. Then “contents of sec3.md + newline” is added.</li>
<li>At the 4th (last) block execution, the result of the previous execution is assigned to <code>s1</code> and the next array element “sec4.md” is assigned to <code>s2</code>. Then “contents of sec4.md + newline” is added.</li>
<li>As a result, “sec1.md contents + newline + sec2.md contents + newline + sec3.md contents + newline + sec4.md contents + newline” is substituted for <code>lerning_rake</code>. In short, it will be a string that combines four files with newlines in between. Line 11 saves it to the file “LearningRake.md”.</li>
</ul>
<p>The reason I added a newline to the end of the file is that in general “a text file may or may not end with a newline”. If you connect the next file without newline, the first character of the second file will not start the line. Then, it is possible that the “#” of the heading is shifted from the beginning of the line and is no longer a heading. A line break is added to avoid this.</p>
<p>The examples are stored in <code>example/example4</code>. Change your current directory to <code>example/example4</code> and execute rake.</p>
<pre><code>$ rake -f Rakefile1
mkdir -p docs
pandoc -s --toc -c style.css -o docs/LearningRake.html LearningRake.md
cp style.css docs/style.css
$</code></pre>
<p>Double click <code>example/example4/docs/LearningRake.html</code>, then your brouwser shows the contents. Make sure that the contents are the same as the ones in <code>sec1.md</code> to <code>sec4.md</code>.</p>
<h4 id="clean-and-clobber">clean and clobber</h4>
<p>In this process, the file “LearningRake.md” is an intermediate file, which may be useless once the target file is created. And it is probably appropriate that such intermediate files should be removed. The clean task performs such operations.</p>
<ul>
<li>require <code>rake/clean</code></li>
<li>Add intermediate files to the FileList object pointed to by the constant <code>CLEAN</code>. There are some methods to add files to <code>CLEAN</code> such as <code>&lt;&lt;</code>, <code>append</code>, <code>push</code>, and <code>include</code>.</li>
<li>Task <code>clean</code> removes all the files stored in <code>CLEAN</code></li>
</ul>
<p>Another useful FileList is <code>CLOBBER</code>.</p>
<ul>
<li>The clobber task deletes files registered with <code>CLEAN</code>.</li>
<li>In addition, it deletes the files registered in <code>CLOBBER</code>.</li>
</ul>
<p>Now, the Rakefile with <code>CLEAN</code> and <code>CLOBBER</code> looks like this:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true"></a>require <span class="st">&#39;rake/clean&#39;</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true"></a>sources = <span class="dt">FileList</span>[<span class="st">&quot;sec*.md&quot;</span>]</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true"></a></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true"></a>task <span class="st">default: </span><span class="ot">%w[</span><span class="st">docs/LearningRake.html docs/style.css</span><span class="ot">]</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true"></a></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true"></a>file <span class="st">&quot;LearningRake.html&quot;</span> =&gt;<span class="ot"> %w[</span><span class="st">LearningRake.md docs</span><span class="ot">]</span> <span class="kw">do</span> |t|</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true"></a>  sh <span class="st">&quot;pandoc -s --toc -c style.css -o </span><span class="ot">#{</span>t.name<span class="ot">}</span><span class="st"> </span><span class="ot">#{</span>t.source<span class="ot">}</span><span class="st">&quot;</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true"></a><span class="dt">CLEAN</span> &lt;&lt; <span class="st">&quot;LearningRake.md&quot;</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true"></a></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true"></a>file <span class="st">&quot;LearningRake.md&quot;</span> =&gt; sources <span class="kw">do</span> |t|</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true"></a>  firstrake = t.sources.inject(<span class="st">&quot;&quot;</span>) {|s1, s2| s1 &lt;&lt; <span class="dt">File</span>.read(s2) + <span class="st">&quot;\n&quot;</span>}</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true"></a>  <span class="dt">File</span>.write(<span class="st">&quot;LearningRake.md&quot;</span>, firstrake)</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true"></a></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true"></a>file <span class="st">&quot;docs/style.css&quot;</span> =&gt;<span class="ot"> %w[</span><span class="st">style.css docs</span><span class="ot">]</span> <span class="kw">do</span> |t|</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true"></a>  cp t.source, t.name</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true"></a></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true"></a>directory <span class="st">&quot;docs&quot;</span></span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true"></a><span class="dt">CLOBBER</span> &lt;&lt; <span class="st">&quot;docs&quot;</span></span></code></pre></div>
<p>The following instruction removes <code>LearningRake.md</code>.</p>
<pre><code>$ rake -f Rakefile2 clean</code></pre>
<p>The following instruction removes all the generated files.</p>
<pre><code>$ rake -f Rakefile2 clobber</code></pre>
</body>
</html>
